import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { 
  Plus, 
  Trash2, 
  ChevronRight, 
  Download, 
  BarChart3, 
  LayoutDashboard, 
  Calendar,
  Wallet,
  ArrowUpCircle,
  ArrowDownCircle,
  Cloud,
  Check,
  FileSpreadsheet,
  AlertCircle
} from 'lucide-react';

// --- Firebase 초기화 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'church-edu-budget-v1';

// --- 유틸리티 함수 ---
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount || 0);
};

// --- 서브 컴포넌트: 요약 시트 ---
const SummarySheet = ({ yearlySummaries, onSelectYear, onAddYear, onExport }) => (
  <div className="space-y-8 animate-in fade-in duration-500">
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
        <div className="flex items-center justify-between mb-4">
          <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">총 누적 수입</span>
          <div className="p-2 bg-emerald-50 rounded-lg text-emerald-600"><ArrowUpCircle size={20} /></div>
        </div>
        <p className="text-2xl font-black text-slate-800">{formatCurrency(yearlySummaries.reduce((s, y) => s + y.totalIncome, 0))}</p>
        <div className="absolute bottom-0 left-0 w-full h-1 bg-emerald-500/20"></div>
      </div>
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
        <div className="flex items-center justify-between mb-4">
          <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">총 누적 지출</span>
          <div className="p-2 bg-rose-50 rounded-lg text-rose-600"><ArrowDownCircle size={20} /></div>
        </div>
        <p className="text-2xl font-black text-slate-800">{formatCurrency(yearlySummaries.reduce((s, y) => s + y.totalExpense, 0))}</p>
        <div className="absolute bottom-0 left-0 w-full h-1 bg-rose-500/20"></div>
      </div>
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
        <div className="flex items-center justify-between mb-4">
          <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">현재 가용 잔액</span>
          <div className="p-2 bg-indigo-50 rounded-lg text-indigo-600"><Wallet size={20} /></div>
        </div>
        <p className="text-2xl font-black text-slate-800">{formatCurrency(yearlySummaries.reduce((s, y) => s + y.balance, 0))}</p>
        <div className="absolute bottom-0 left-0 w-full h-1 bg-indigo-500/20"></div>
      </div>
    </div>

    <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
      <div className="p-6 border-b border-slate-100 flex items-center justify-between flex-wrap gap-4">
        <h3 className="font-bold text-lg flex items-center gap-2"><BarChart3 size={20} className="text-indigo-500" /> 연도별 요약 통계</h3>
        <div className="flex gap-2">
          <button onClick={onExport} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-100 hover:bg-emerald-100 transition">
            <FileSpreadsheet size={14} /> 엑셀 파일 내보내기
          </button>
          <button onClick={onAddYear} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition">
            <Plus size={14} /> 새 연도 추가
          </button>
        </div>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-left">
          <thead className="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-bold tracking-widest">
            <tr>
              <th className="px-8 py-4">연도</th>
              <th className="px-8 py-4 text-right">수입 (Income)</th>
              <th className="px-8 py-4 text-right">지출 (Expense)</th>
              <th className="px-8 py-4 text-right">차액 (Balance)</th>
              <th className="px-8 py-4 w-16"></th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-50">
            {yearlySummaries.map(s => (
              <tr key={s.year} onClick={() => onSelectYear(s.year)} className="hover:bg-indigo-50/30 transition-colors cursor-pointer group">
                <td className="px-8 py-5 font-bold text-slate-700">{s.year}년도</td>
                <td className="px-8 py-5 text-right text-emerald-600 font-medium">{formatCurrency(s.totalIncome)}</td>
                <td className="px-8 py-5 text-right text-rose-500 font-medium">{formatCurrency(s.totalExpense)}</td>
                <td className={`px-8 py-5 text-right font-black ${s.balance >= 0 ? 'text-indigo-600' : 'text-rose-700'}`}>{formatCurrency(s.balance)}</td>
                <td className="px-8 py-5 text-right"><ChevronRight size={18} className="text-slate-300 group-hover:text-indigo-500 transition-colors" /></td>
              </tr>
            ))}
            {yearlySummaries.length === 0 && (
              <tr>
                <td colSpan="5" className="px-8 py-20 text-center text-slate-400 italic">데이터가 없습니다. 새로운 연도를 추가해 주세요.</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  </div>
);

// --- 서브 컴포넌트: 연도 상세 시트 ---
const YearDetailSheet = ({ year, yearData, onAddEntry, onUpdateEntry, onDeleteEntry }) => {
  const totalInc = yearData?.income?.reduce((s, i) => s + (Number(i.amount) || 0), 0) || 0;
  const totalExp = yearData?.expense?.reduce((s, i) => s + (Number(i.amount) || 0), 0) || 0;

  return (
    <div className="space-y-8 animate-in slide-in-from-right-4 duration-300">
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-slate-800">{year}년 상세 내역</h2>
          <p className="text-slate-500 text-sm">실시간 클라우드 아카이빙이 활성화되어 있습니다.</p>
        </div>
        <div className="flex gap-2">
           <div className="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-xl border border-emerald-100 text-center min-w-[120px]">
             <span className="text-[10px] block font-bold uppercase tracking-wider opacity-60">총 수입</span>
             <span className="font-bold text-lg">{formatCurrency(totalInc)}</span>
           </div>
           <div className="px-4 py-2 bg-rose-50 text-rose-700 rounded-xl border border-rose-100 text-center min-w-[120px]">
             <span className="text-[10px] block font-bold uppercase tracking-wider opacity-60">총 지출</span>
             <span className="font-bold text-lg">{formatCurrency(totalExp)}</span>
           </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* 수입 테이블 */}
        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-5 bg-emerald-500 text-white flex justify-between items-center">
            <h3 className="font-bold flex items-center gap-2"><ArrowUpCircle size={18} /> 수입 (Income)</h3>
            <button onClick={() => onAddEntry(year, 'income')} className="p-1.5 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"><Plus size={18} /></button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold tracking-widest">
                <tr>
                  <th className="px-4 py-3 text-left">날짜</th>
                  <th className="px-4 py-3 text-left">분류</th>
                  <th className="px-4 py-3 text-left">내용</th>
                  <th className="px-4 py-3 text-right">금액</th>
                  <th className="px-2 w-10"></th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {yearData?.income?.map(item => (
                  <tr key={item.id} className="hover:bg-slate-50/50">
                    <td className="px-4 py-2"><input type="date" value={item.date} onChange={e => onUpdateEntry(year, 'income', item.id, 'date', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 rounded" /></td>
                    <td className="px-4 py-2">
                      <select value={item.category} onChange={e => onUpdateEntry(year, 'income', item.id, 'category', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 rounded">
                        <option value="교회 지원금">교회 지원금</option>
                        <option value="헌금">헌금</option>
                        <option value="기부금">기부금</option>
                        <option value="기타">기타</option>
                      </select>
                    </td>
                    <td className="px-4 py-2"><input type="text" value={item.detail} onChange={e => onUpdateEntry(year, 'income', item.id, 'detail', e.target.value)} placeholder="내용 입력" className="w-full bg-transparent border-none text-xs p-1 rounded" /></td>
                    <td className="px-4 py-2"><input type="number" value={item.amount} onChange={e => onUpdateEntry(year, 'income', item.id, 'amount', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 font-bold text-emerald-600 text-right rounded" /></td>
                    <td className="px-2 py-2"><button onClick={() => onDeleteEntry(year, 'income', item.id)} className="text-slate-200 hover:text-rose-500"><Trash2 size={14} /></button></td>
                  </tr>
                ))}
                {!yearData?.income?.length && <tr><td colSpan="5" className="px-4 py-10 text-center text-slate-400 text-xs italic">내역이 없습니다.</td></tr>}
              </tbody>
            </table>
          </div>
        </div>

        {/* 지출 테이블 */}
        <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-5 bg-rose-500 text-white flex justify-between items-center">
            <h3 className="font-bold flex items-center gap-2"><ArrowDownCircle size={18} /> 지출 (Expense)</h3>
            <button onClick={() => onAddEntry(year, 'expense')} className="p-1.5 bg-white/20 hover:bg-white/30 rounded-lg transition-colors"><Plus size={18} /></button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold tracking-widest">
                <tr>
                  <th className="px-4 py-3 text-left">날짜</th>
                  <th className="px-4 py-3 text-left">분류</th>
                  <th className="px-4 py-3 text-left">내용</th>
                  <th className="px-4 py-3 text-right">금액</th>
                  <th className="px-2 w-10"></th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {yearData?.expense?.map(item => (
                  <tr key={item.id} className="hover:bg-slate-50/50">
                    <td className="px-4 py-2"><input type="date" value={item.date} onChange={e => onUpdateEntry(year, 'expense', item.id, 'date', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 rounded" /></td>
                    <td className="px-4 py-2">
                      <select value={item.category} onChange={e => onUpdateEntry(year, 'expense', item.id, 'category', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 rounded">
                        <option value="교육 소모품">교육 소모품</option>
                        <option value="교육 자료">교육 자료</option>
                        <option value="행사비">행사비</option>
                        <option value="식비/간식">식비/간식</option>
                        <option value="기타">기타</option>
                      </select>
                    </td>
                    <td className="px-4 py-2"><input type="text" value={item.detail} onChange={e => onUpdateEntry(year, 'expense', item.id, 'detail', e.target.value)} placeholder="내용 입력" className="w-full bg-transparent border-none text-xs p-1 rounded" /></td>
                    <td className="px-4 py-2"><input type="number" value={item.amount} onChange={e => onUpdateEntry(year, 'expense', item.id, 'amount', e.target.value)} className="w-full bg-transparent border-none text-xs p-1 font-bold text-rose-600 text-right rounded" /></td>
                    <td className="px-2 py-2"><button onClick={() => onDeleteEntry(year, 'expense', item.id)} className="text-slate-200 hover:text-rose-500"><Trash2 size={14} /></button></td>
                  </tr>
                ))}
                {!yearData?.expense?.length && <tr><td colSpan="5" className="px-4 py-10 text-center text-slate-400 text-xs italic">내역이 없습니다.</td></tr>}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- 메인 App 컴포넌트 ---
const App = () => {
  const [data, setData] = useState({});
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('summary');
  const [isSyncing, setIsSyncing] = useState(false);
  const [error, setError] = useState(null);

  // 인증 및 데이터 초기 로딩 (RULE 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        setError("인증 연결에 실패했습니다.");
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    // 경로 수정: 짝수 세그먼트 보장 (RULE 1)
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'budget_store', 'main');
    
    const unsubscribeData = onSnapshot(docRef, 
      (docSnap) => {
        if (docSnap.exists()) {
          setData(docSnap.data().content || {});
        } else {
          const initial = { "2025": { income: [], expense: [] } };
          setDoc(docRef, { content: initial });
          setData(initial);
        }
      }, 
      (err) => {
        setError("데이터 동기화 중 오류가 발생했습니다.");
      }
    );

    return () => unsubscribeData();
  }, [user]);

  const syncToCloud = async (newData) => {
    if (!user) return;
    setIsSyncing(true);
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'budget_store', 'main');
      await setDoc(docRef, { content: newData });
    } catch (err) {
      setError("클라우드 저장에 실패했습니다.");
    } finally {
      setTimeout(() => setIsSyncing(false), 1000);
    }
  };

  // 계산 로직
  const years = Object.keys(data).sort((a, b) => b - a);
  const yearlySummaries = useMemo(() => {
    return Object.keys(data).map(year => {
      const totalIncome = data[year].income?.reduce((sum, item) => sum + (Number(item.amount) || 0), 0) || 0;
      const totalExpense = data[year].expense?.reduce((sum, item) => sum + (Number(item.amount) || 0), 0) || 0;
      return { year, totalIncome, totalExpense, balance: totalIncome - totalExpense };
    }).sort((a, b) => b.year - a.year);
  }, [data]);

  // 핸들러
  const handleAddYear = () => {
    const nextYear = (Math.max(...(years.length ? years.map(Number) : [2024])) + 1).toString();
    const newData = { ...data, [nextYear]: { income: [], expense: [] } };
    setData(newData);
    syncToCloud(newData);
    setActiveTab(nextYear);
  };

  const handleAddEntry = (year, type) => {
    const newEntry = {
      id: Date.now(),
      date: new Date().toISOString().split('T')[0],
      category: type === 'income' ? '교회 지원금' : '교육 소모품',
      detail: '',
      amount: 0
    };
    const newData = { ...data, [year]: { ...data[year], [type]: [...(data[year][type] || []), newEntry] } };
    setData(newData);
    syncToCloud(newData);
  };

  const handleUpdateEntry = (year, type, id, field, value) => {
    const updated = data[year][type].map(item => 
      item.id === id ? { ...item, [field]: field === 'amount' ? Number(value) : value } : item
    );
    const newData = { ...data, [year]: { ...data[year], [type]: updated } };
    setData(newData);
    syncToCloud(newData);
  };

  const handleDeleteEntry = (year, type, id) => {
    if (!window.confirm("항목을 삭제하시겠습니까?")) return;
    const newData = { ...data, [year]: { ...data[year], [type]: data[year][type].filter(i => i.id !== id) } };
    setData(newData);
    syncToCloud(newData);
  };

  const handleExport = () => {
    let csv = "\uFEFF구분,연도,날짜,분류,적요,금액\n";
    Object.keys(data).sort().forEach(y => {
      data[y].income?.forEach(i => csv += `수입,${y},${i.date},${i.category},"${i.detail}",${i.amount}\n`);
      data[y].expense?.forEach(e => csv += `지출,${y},${e.date},${e.category},"${e.detail}",${e.amount}\n`);
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `교회결산_${new Date().toLocaleDateString()}.csv`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row text-slate-900 font-sans">
      <aside className="w-full md:w-64 bg-slate-900 text-white shrink-0 p-6 flex flex-col">
        <div className="flex items-center gap-3 mb-8 px-2">
          <div className="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center shadow-lg"><Calendar className="w-6 h-6" /></div>
          <div><h1 className="font-bold text-lg leading-tight">교육부서</h1><p className="text-[10px] text-slate-400 uppercase tracking-widest">Finance Management</p></div>
        </div>

        <nav className="flex-1 space-y-1">
          <button onClick={() => setActiveTab('summary')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${activeTab === 'summary' ? 'bg-indigo-600' : 'text-slate-400 hover:bg-slate-800'}`}><LayoutDashboard size={18} /> 통합 요약</button>
          <div className="pt-6 pb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Archives</div>
          {years.map(y => (
            <button key={y} onClick={() => setActiveTab(y)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all ${activeTab === y ? 'bg-slate-700' : 'text-slate-400 hover:bg-slate-800'}`}><div className={`w-1.5 h-1.5 rounded-full ${activeTab === y ? 'bg-indigo-400' : 'bg-slate-600'}`}></div> {y}년도</button>
          ))}
          <button onClick={handleAddYear} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-indigo-400 border border-indigo-900/50 border-dashed mt-4 hover:bg-indigo-900/20"><Plus size={18} /> 새 연도 추가</button>
        </nav>

        <div className="mt-auto pt-6 border-t border-slate-800">
          <div className={`flex items-center gap-2 px-2 text-xs transition-colors duration-500 ${isSyncing ? 'text-indigo-400' : 'text-emerald-400'}`}>{isSyncing ? <Cloud className="animate-pulse" size={14} /> : <Check size={14} />} <span>{isSyncing ? '저장 중...' : '클라우드 동기화됨'}</span></div>
          <button onClick={() => window.print()} className="w-full mt-4 flex items-center gap-2 text-xs font-bold text-slate-400 hover:text-white px-2"><Download size={14} /> PDF 인쇄</button>
        </div>
      </aside>

      <main className="flex-1 overflow-y-auto p-6 md:p-10 max-w-7xl mx-auto w-full">
        {error && <div className="mb-6 p-4 bg-rose-50 border border-rose-200 rounded-xl flex items-center gap-3 text-rose-700 text-sm font-medium animate-in fade-in slide-in-from-top-2"><AlertCircle size={18} /> {error}</div>}
        
        <header className="mb-8">
          <h2 className="text-xs font-bold text-indigo-600 uppercase tracking-widest mb-1">Church Education Ministry</h2>
          <h1 className="text-3xl font-black text-slate-900">
            {activeTab === 'summary' ? '교회 교육부서 예산 결산 관리' : `${activeTab}년도 상세 결산`}
          </h1>
        </header>

        {activeTab === 'summary' ? (
          <SummarySheet yearlySummaries={yearlySummaries} onSelectYear={setActiveTab} onAddYear={handleAddYear} onExport={handleExport} />
        ) : (
          <YearDetailSheet year={activeTab} yearData={data[activeTab]} onAddEntry={handleAddEntry} onUpdateEntry={handleUpdateEntry} onDeleteEntry={handleDeleteEntry} />
        )}
      </main>
    </div>
  );
};

export default App;